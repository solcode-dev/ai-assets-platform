# Backend Skill Checklist & Best Practices (Senior Level)

백엔드(FastAPI, Celery, Python) 관련 요청을 처리할 때 준수해야 할 **최우선 기술 지점(Source of Truth)**입니다. 본 문서는 프로젝트의 모든 서버 사이드 구현 및 운영 기준이 되며, 코드 구현 시 본 문서의 원칙을 최우선으로 검토합니다.

## 1. 서버 아키텍처 및 무결성 원칙 (Constitution)
- **비즈니스 로직의 원자성(Atomicity)**: 
    - DB 업데이트와 외부 시스템(Vertex AI, Storage, Pub/Sub) 간의 인터랙션 발생 시, 실패 상황에 대한 보상 트랜잭션 또는 최종 일관성(Eventual Consistency) 확보를 위한 재시도 로직을 필히 설계합니다.
- **멱등성 보장(Idempotency)**: 
    - 모든 Celery 태스크 및 데이터 변경 API는 중복 호출 시에도 부작용(Side Effect)이 없어야 하며, `job_id`를 통한 상태 가드 로직을 필수로 구현합니다.
- **관심사 격리 (Layered Architecture)**: 
    - `api/`(진입점), `services/`(도메인 로직), `infrastructure/`(DB/외부 연동) 레이어를 엄격히 분리하여 인프라 변경이 비즈니스 로직을 침해하지 않도록 합니다.

## 2. AI 멀티모달 운영 및 LRO 관리
- **AI 쿼터 및 리소스 제어**: 
    - 외부 AI API 호출 시 Redis 기반의 활성 요청 수 추적을 통해 플랫폼 할당량을 관리하며, 초과 시 Backpressure 전략을 수행합니다.
- **LRO (Long Running Operations) 표준**: 
    - 비디오 생성 등 장기 작업은 '비동기 요청 -> 상태 폴링/SSE 전파 -> 완료 처리'의 표준 생명주기를 준수해야 하며, 누락 없는 상태 복구 시나리오를 갖춥니다.
- **Safety & Error Handling**: 
    - AI 모델의 차단(Safety Block) 시 단순 에러가 아닌 사용자 안내가 포함된 구조화된 예외를 반환하며, 영구적 오류와 일시적 오류를 구분하여 재시도 전략을 차등 적용합니다.

## 3. 시스템 복원력 및 관측 가능성 (Observability)
- **분산 트레이싱 (Trace ID 전파)**: 
    - 모든 API 요청 및 파생되는 워커 태스크까지 동일한 `X-Trace-ID`를 공유하여 전 구간 로그 추적성을 보장합니다.
- **서킷 브레이커 및 타임아웃**: 
    - 외부 의존성(AI 센서, 클라우드 스토리지) 연동 시 반드시 타임아웃을 설정하며, 장애 확산 방지를 위한 서킷 브레이커 전략을 적용합니다.
- **Graceful Lifecycle**: 
    - 서비스 종료 시 리소스(DB 엔진 폐기 등)를 안전하게 해제하고 지연 작업을 마무리하는 `lifespan` 로직을 준수합니다.

## 4. 인프라 최적화 및 보안
- **자원 할당 및 격리**: 
    - API 엔진과 워커 엔진의 커넥션 풀링 전략(`NullPool` 활용 등)을 차별화하여 프로세스 간 간섭을 방지합니다.
- **미디어 검증 및 최적화**: 
    - 대용량 에셋 처리 시 서버 메모리를 보호하기 위해 스트리밍 처리 및 바이너리 최적화를 수행하며, 정확한 MIME 타입 검증을 선행합니다.
- **보안 원칙**: 
    - 프롬프트 인젝션 방어, 환경 변수를 통한 민감 정보 관리, 내부 API 서버 간 상호 인증 기준을 준수합니다.

## 5. 지침의 권위 및 준수
- 본 문서는 프로젝트의 백엔드 **'코드 헌법'**입니다. 
- 새로운 기능이나 아키텍처 도입 시 본 지침과의 정합성을 가장 먼저 검토하며, 지침은 최상의 기술적 표준으로서의 권위와 일관성을 유지합니다.
