.PHONY: test-setup test test-unit test-integration test-e2e test-cov test-down

# ============================================================================
# í…ŒìŠ¤íŠ¸ í™˜ê²½ êµ¬ì„±
# ============================================================================
test-setup:
	@echo "ğŸš€ Setting up test environment..."
	docker-compose -f docker-compose.test.yml up -d
	@echo "â³ Waiting for PostgreSQL to be ready..."
	@sleep 5
	@echo "ğŸ“¦ Installing test dependencies..."
	../venv/bin/pip install -r requirements-test.txt
	../venv/bin/playwright install chromium
	@echo "âœ… Test environment ready!"

# ============================================================================
# í…ŒìŠ¤íŠ¸ ìœ í‹¸ë¦¬í‹°
# ============================================================================
ensure-test-db:
	@if ! docker ps --filter name=krafton_test_db --format '{{.Names}}' | grep -q 'krafton_test_db'; then \
		echo "ğŸš€ Test database is not running. Starting it now..."; \
		docker-compose -f docker-compose.test.yml up -d test-db; \
		echo "â³ Waiting for database to be ready..."; \
		sleep 5; \
	fi

# ============================================================================
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# ============================================================================
test: ensure-test-db
	@echo "ğŸ§ª Running all tests..."
	../venv/bin/pytest tests/ -v

test-unit: ensure-test-db
	@echo "ğŸ”¬ Running unit tests..."
	../venv/bin/pytest tests/unit/ -m unit -v

test-integration: ensure-test-db
	@echo "ğŸ”— Running integration tests..."
	../venv/bin/pytest tests/integration/ -m integration -v

test-e2e: ensure-test-db
	@echo "ğŸŒ Running E2E tests..."
	../venv/bin/pytest tests/e2e/ -m e2e -v

# ============================================================================
# ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸
# ============================================================================
test-cov: ensure-test-db
	@echo "ğŸ“Š Running tests with coverage..."
	../venv/bin/pytest --cov=app --cov-report=html --cov-report=term-missing --cov-branch --cov-config=.coveragerc --cov-fail-under=90
	@echo ""
	@echo "âœ… Coverage report generated!"
	@echo "ğŸ“„ HTML report: file://$(PWD)/htmlcov/index.html"
	@echo ""

# ============================================================================
# í…ŒìŠ¤íŠ¸ í™˜ê²½ ì¢…ë£Œ
# ============================================================================
test-down:
	@echo "ğŸ›‘ Stopping test environment..."
	docker-compose -f docker-compose.test.yml down -v
	@echo "âœ… Test environment stopped!"

# ============================================================================
# í—¬í”„
# ============================================================================
help:
	@echo "Available test commands:"
	@echo "  make test-setup      - Setup test environment (Docker + dependencies)"
	@echo "  make test            - Run all tests"
	@echo "  make test-unit       - Run unit tests only"
	@echo "  make test-integration- Run integration tests only"
	@echo "  make test-e2e        - Run E2E tests only"
	@echo "  make test-cov        - Run tests with coverage report"
	@echo "  make test-down       - Stop test environment"
